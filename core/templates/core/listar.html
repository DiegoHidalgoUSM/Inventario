<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Activos</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    
    {% if user.is_authenticated %}
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="/home/">Home</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <button class="btn btn-outline-secondary" onclick="window.location.href='/importar/'">Importar</button>
                </li>
                <li class="nav-item">
                    <button class="btn btn-outline-secondary" onclick="window.location.href='/añadir/'">Añadir</button>
                </li>
                <li class="nav-item">
                    <form method="post" action="{% url 'logout' %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">Cerrar Sesión</button>
                    </form>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container mt-5">
        <h1 class="text-center">Lista de Activos</h1>
        <div class="row">
            <div class="row">
                <div class="col-md-10 sin-borde"> <!-- Agregamos la clase "sin-borde" aquí -->
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filtroModal">
                        Filtro
                    </button>
                    <div class="modal fade" id="filtroModal" tabindex="-1" aria-labelledby="filtroModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="filtroModalLabel">Filtro</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <!-- Contenido del formulario de filtrado -->
                                    <form id="filtroForm" class="mb-4" onsubmit="guardarFiltros(event)">
                                        <div class="row mt-3">
                                            <div class="col">
                                                <div class="form-check mb-2">
                                                    <input type="checkbox" class="form-check-input" id="chkResponsable" name="filtro" value="Responsable" onchange="mostrarSelect(this)" {% if responsable_seleccionado %}checked{% endif %}>
                                                    <label class="form-check-label" for="chkResponsable">Responsable</label>
                                                </div>
                                                <select id="selectResponsable" class="form-select" style="display: {% if responsable_seleccionado %}block{% else %}none{% endif %};">
                                                    {% for responsable in responsables %}
                                                    <option value="{{ responsable.nombre }}" {% if responsable.nombre == responsable_seleccionado %}selected{% endif %}>{{ responsable.nombre }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col">
                                                <div class="form-check mb-2">
                                                    <input type="checkbox" class="form-check-input" id="chkCarrera" name="filtro" value="Carrera" onchange="mostrarSelect(this)" {% if carrera_seleccionada %}checked{% endif %}>
                                                    <label class="form-check-label" for="chkCarrera">Carrera</label>
                                                </div>
                                                <select id="selectCarrera" class="form-select" style="display: {% if carrera_seleccionada %}block{% else %}none{% endif %};">
                                                    {% for carrera in carreras %}
                                                    <option value="{{ carrera.nombre }}" {% if carrera.nombre == carrera_seleccionada %}selected{% endif %}>{{ carrera.nombre }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col">
                                                <div class="form-check mb-2">
                                                    <input type="checkbox" class="form-check-input" id="chkUbicacion" name="filtro" value="Ubicacion" onchange="mostrarSelect(this)" {% if ubicacion_seleccionada %}checked{% endif %}>
                                                    <label class="form-check-label" for="chkUbicacion">Ubicación</label>
                                                </div>
                                                <select id="selectUbicacion" class="form-select" style="display: {% if ubicacion_seleccionada %}block{% else %}none{% endif %};">
                                                    {% for ubicacion in ubicaciones %}
                                                    <option value="{{ ubicacion.nombre }}" {% if ubicacion.nombre == ubicacion_seleccionada %}selected{% endif %}>{{ ubicacion.nombre }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-auto">
                                                <label for="buscar" class="form-label">Buscar:</label>
                                                <input type="text" class="form-control" id="buscar" name="buscar" value="{{ termino_busqueda }}">
                                            </div>
                                            <div class="modal-footer justify-content-end">
                                                <button type="submit" class="btn btn-primary">Buscar</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="ms-auto mt-auto">
                        <a href="{% url 'exportar_excel' %}?buscar={{ termino_busqueda }}" class="btn btn-primary">Exportar a Excel</a>
                    </div>
                </div>
            </div>
        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>Etiqueta</th>
                    <th>Número de Serie</th>
                    <th>Descripción</th>
                    <th>Responsable</th>
                    <th>Carrera</th>
                    <th>Ubicación</th>
                    <th>Observación</th>
                    <th>Digitador</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for item in listado %}
                <tr>
                    <td>{{ item.Etiqueta }}</td>
                    <td>{{ item.Numero_Serie }}</td>
                    <td>{{ item.Descripcion_Equipamiento }}</td>
                    <td><span>{{ item.Responsable }}</span>
                    </td>
                    
                    <td>{{ item.Carrera }}</td>
                    <td>{{ item.Ubicacion }}</td>
                    <td>{{ item.Observacion }}</td>
                        <td>{{ item.Digitador }}</td>
                    <td class="text-center">
                        <button onclick="abrirModalModificar({{ item.id }}, '{{ item.Etiqueta }}', '{{ item.Numero_Serie }}', '{{ item.Descripcion_Equipamiento }}', '{{ item.Responsable }}', '{{ item.Carrera }}', '{{ item.Ubicacion }}', '{{ item.Observacion }}', '{{ item.Digitador }}')">Modificar</button>
                            
                            <button class="btn btn-link p-0" onclick="eliminarItem('{{ item.id }}')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    <div class="{{item.id}}""></div>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="modalModificar" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="cerrarModal('modificar')">&times;</span>
                    <h2>Modificar Activo</h2>
                    <!-- Agrega este formulario debajo del formulario existente -->
                    <form id="formModificarActivo" onsubmit="guardarCambios(event)">
                        {% csrf_token %}
                        <input type="hidden" id="modificar_id" name="id">
                        <div>
                            <!-- Campos para modificar -->
                            <label for="modificar_etiqueta">Etiqueta</label>
                            <input type="text" id="modificar_etiqueta" name="Etiqueta" required><br>
                            <label for="modificar_numero_serie">Número de Serie</label>
                            <input type="text" id="modificar_numero_serie" name="Numero_Serie" required><br>
                            <label for="modificar_descripcion">Descripción del Equipamiento</label>
                            <input type="text" id="modificar_descripcion" name="Descripcion_Equipamiento" required><br>
                            
                            <label for="modificar_responsable">Responsable</label>
                            <select id="modificar_responsable" name="Responsable" required>
                                {% for responsable in responsables %}
                                    <option value="{{ responsable.nombre }}">{{ responsable.nombre }}</option>
                                {% endfor %}
                            </select><br>
                            
                            <label for="modificar_carrera">Carrera Asociada</label>
                            <select id="modificar_carrera" name="Carrera" required>
                                {% for carrera in carreras %}
                                    <option value="{{ carrera.nombre }}">{{ carrera.nombre }}</option>
                                {% endfor %}
                            </select><br>
                            
                            <label for="modificar_ubicacion">Ubicación</label>
                            <select id="modificar_ubicacion" name="Ubicacion" required>
                                {% for ubicacion in ubicaciones %}
                                    <option value="{{ ubicacion.nombre }}">{{ ubicacion.nombre }}</option>
                                {% endfor %}
                            </select><br>
                            
                            <label for="modificar_observacion">Observación</label>
                            <input type="text" id="modificar_observacion" name="Observacion"><br>
                            
                            <label for="modificar_digitador">Digitador</label>
                            <input type="text" id="modificar_digitador" name="Digitador" required readonly><br>
                        </div>
                        <button type="submit">Guardar Cambios</button>
                    </form>
        
                </div>
            </div>
            <button class="btn btn-primary" onclick="cargarMas()">Listar más</button>
        </div>
        <!-- CSS de Bootstrap -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">

        <!-- CSS de Bootstrap Icons (opcional) -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/bootstrap-icons.min.css" rel="stylesheet">

        <!-- JavaScript de jQuery -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

        <!-- JavaScript de Bootstrap -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>


        <script>
            function abrirModal(tipo) {
                document.getElementById('modal' + capitalizeFirstLetter(tipo)).style.display = 'block';
            }

            function cerrarModal(tipo) {
                document.getElementById('modal' + capitalizeFirstLetter(tipo)).style.display = 'none';
            }

            function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }
            function abrirModalModificar(id, etiqueta, numeroSerie, descripcion, responsable, carrera, ubicacion, observacion, digitador) {
                document.getElementById('modificar_id').value = id;
                document.getElementById('modificar_etiqueta').value = etiqueta;
                document.getElementById('modificar_numero_serie').value = numeroSerie;
                document.getElementById('modificar_descripcion').value = descripcion;
                document.getElementById('modificar_responsable').value = responsable;
                document.getElementById('modificar_carrera').value = carrera;
                document.getElementById('modificar_ubicacion').value = ubicacion;
                document.getElementById('modificar_observacion').value = observacion;
                document.getElementById('modificar_digitador').value = digitador;
                abrirModal('modificar');
            }
            function guardarCambios(event) {
                event.preventDefault();  // Evitar el envío del formulario estándar
                var form = document.getElementById('formModificarActivo');
                var data = new FormData(form);
                var itemId = document.getElementById('modificar_id').value;  // Obtener el ID del elemento a modificar
                enviarDatosModificacion(data, itemId);  // Pasar el ID del elemento como argumento
            }
    
            function enviarDatosModificacion(data, itemId) {
                fetch(`/modificar-activo/${itemId}/`, {
                    method: 'POST',
                    body: data,
                    headers: {'X-CSRFToken': '{{ csrf_token }}'}
                })
                .then(response => {
                    if (response.ok) {
                        // Mostrar mensaje de éxito
                        alert('Datos modificados correctamente');
                        
                        // Preguntar al usuario si desea recargar la página
                        if (confirm('¿Desea recargar la página para ver los cambios?')) {
                            location.reload(); // Recargar la página
                        } else {
                            cerrarModal('modificar');
                            actualizarListado(); // Actualizar el listado después de cerrar el modal
                        }
                    } else {
                        console.error('Error al modificar datos');
                    }
                })
                .catch(error => {
                    console.error('Error de red:', error);
                });
            }
            function eliminarItem(itemId) {
                if (window.confirm("¿Seguro que desea borrar en la lista?")) {
                    fetch(`/eliminar/${itemId}/`, {
                        method: 'DELETE',
                        headers: {'Content-Type': 'application/json','X-CSRFToken': '{{ csrf_token }}'},
                    })
                    .then(response => {
                        if (response.ok) {
                            console.log('Elemento eliminado correctamente');
                            window.confirm("Se ha borrado elemento de la lista");
                            window.location.href = "/lista/";
                        } else {
                            console.error('Error al eliminar elemento');
                        }
                    })
                    .catch(error => {
                        console.error('Error de red:', error);
                    });
                }
            }
    
            function mostrarSelect(checkbox) {
                var selectId = 'select' + checkbox.value;
                var select = document.getElementById(selectId);
                if (checkbox.checked) {
                    select.style.display = 'block';
                } else {
                    select.style.display = 'none';
                }
            }
            function exportarExcel() {
                var url = "{% url 'exportar_excel' %}";
                var filtros = JSON.parse(sessionStorage.getItem('filtros')) || [];
                var termino_busqueda = sessionStorage.getItem('termino_busqueda') || '';
                if (filtros.length > 0 || termino_busqueda) {
                    url += "?";
                    if (filtros.length > 0) {
                        url += "filtro=" + filtros.join("&filtro=");
                    }
                    if (termino_busqueda) {
                        url += (filtros.length > 0 ? "&" : "") + "buscar=" + encodeURIComponent(termino_busqueda);
                    }
                }
                window.location.href = url;
            }
            function guardarFiltros(event) {
                event.preventDefault();  // Evita el envío del formulario estándar
                var form = document.getElementById('filtroForm');
                var data = new FormData(form);
                var buscar = data.get('buscar');
                var url = new URL(window.location.href);
                var params = url.searchParams;
    
                // Limpiar parámetros anteriores
                params.delete('filtro');
                params.delete('buscar');
                params.delete('Responsable');
                params.delete('Carrera');
                params.delete('Ubicacion');
    
                // Añadir término de búsqueda
                if (buscar) {
                    params.set('buscar', buscar);
                }
    
                // Añadir filtros específicos si están seleccionados
                if (data.has('filtro')) {
                    data.getAll('filtro').forEach(filtro => {
                        var select = document.getElementById('select' + filtro);
                        if (select && select.style.display !== 'none' && select.value) {
                            params.append(filtro, select.value);
                        }
                    });
                }
    
                // Redirige a la URL con los parámetros de filtro
                window.location.href = url.toString();
            }
    
            function mostrarSeccion2() {
                document.getElementById('seccion1').classList.remove('active');
                document.getElementById('seccion2').classList.add('active');
            }
    
            function mostrarSeccion1() {
                document.getElementById('seccion2').classList.remove('active');
                document.getElementById('seccion1').classList.add('active');
            }
    
            document.getElementById('formulario').addEventListener('submit', function(event) {
                event.preventDefault(); // Prevenir envío automático del formulario
                            // Obtener los valores de número de serie y etiqueta
            const numeroSerie = document.getElementById('numero_serie').value;
            const etiqueta = document.getElementById('etiqueta').value;

            // Realizar la lógica para agregar el activo

            // Limpia el formulario
            document.getElementById('formulario').reset();
        });

        function expandir(elemento) {
            elemento.classList.toggle("active");
            var contenido = elemento.nextElementSibling;
            if (contenido.style.maxHeight) {
                contenido.style.maxHeight = null;
            } else {
                contenido.style.maxHeight = contenido.scrollHeight + "px";
            }
        }

        function modificarCampo(campo, itemId) {
            var nuevoValor = document.getElementById(campo + '_' + itemId).value;
            fetch(`/modificar-campo/${itemId}/`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json','X-CSRFToken': '{{ csrf_token }}'},
                body: JSON.stringify({campo: campo, valor: nuevoValor})
            })
            .then(response => {
                if (response.ok) {
                    console.log('Campo modificado correctamente');
                    actualizarListado(); // Actualizar el listado después de modificar el campo
                } else {
                    console.error('Error al modificar campo');
                }
            })


            .catch(error => {
                console.error('Error de red:', error);
            });
        }

        function actualizarListado() {
            // Simplemente recarga la página para actualizar el listado completo
            window.location.reload();
        }

        function cargarMas() {
            // Aquí puedes implementar la lógica para cargar más elementos en la lista
            // Por ejemplo, mediante AJAX o fetch
            // Al cargar más elementos, puedes agregarlos a la tabla actual o reemplazarla, dependiendo de tu diseño y preferencias.
            alert('Implementa la lógica para cargar más elementos en la lista');
        }
    </script>
    {% endif %}
</body>
</html>

                
    